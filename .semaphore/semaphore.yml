version: v1.0
name: Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: 'Test all PHP versions'
    task:
      jobs:
        - name: 'PHP Version'
          matrix:
            - env_var: PHP_VERSION
              values: [ "8.0.28", "8.1.17", "8.2.4" ]
          commands:
            - checkout
            - source ~/.phpbrew/bashrc
            - cache restore php-$PHP_VERSION
            - phpbrew install -j $(nproc) $PHP_VERSION +default
            - cache store php-$PHP_VERSION /home/semaphore/.phpbrew/php/php-$PHP_VERSION
            - phpbrew use php-$PHP_VERSION
            - cache restore
            - sudo apt-get install composer
            - composer install --no-progress --no-suggest --prefer-dist -o
            - cache store
            - ./vendor/bin/phpunit test
